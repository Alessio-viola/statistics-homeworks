<!DOCTYPE html>
<html>
<head>
    <title>Grafico Cartesiano con Numeri</title>
    <style>
        #resizableRect {
            position: relative;
            width: 400px;
            height: 300px;
            background-color: lightblue;
            resize: both;
            overflow: auto;
        }

        .graph-container {
            position: relative;
            width: 400px;
            height: 300px;
            background-color: lightblue;
            resize: both;
            overflow: auto;
        
        }
    </style>
</head>
<body>

    <h1>Simulazione Tracciamento Sicurezza</h1>
    <p>Inserisci i valori:</p>
    <label for="numSystems">Numero di sistemi (N):</label>
    <input type="number" id="numSystems" value="5"><br>
    <label for "numAttacks">Numero di attacchi (M):</label>
    <input type="number" id="numAttacks" value="10"><br>
    <label for="attackProbability">Probabilità di successo di un attacco (p):</label>
    <input type="number" step="0.01" id="attackProbability" value="0.5"><br>
    <label for="startPoint">Punto di inizio (x):</label>
    <input type="number" id="startPoint" value="0"><br>
    <button id="simulazione">Simula</button>
    
    <label for="trajectories">trajectories</label>
    <div id="resizableRect">
        <canvas id="securityChart" width="400" height="300"></canvas>
    </div>
    <label for="cumulative">Cumulative Case</label>
    <div class="graph-container" id="cumulativeGraph">
        <canvas id="cumulativeChart" width="400" height="300"></canvas>
    </div>
    <label for="relative">Relative Case</label>
    <div class="graph-container" id="relativeGraph">
        <canvas id="relativeChart" width="400" height="300"></canvas>
    </div>
    <label for="normalized">Normalized Case</label>
    <div class="graph-container" id="normalizedGraph">
        <canvas id="normalizedChart" width="400" height="300"></canvas>
    </div>

    <script>

        const colors = ["#ff5733", "#33ff57", "#3366ff", "#ff3366", "#66ff33"];


        class My2dUtilities {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.context = this.canvas.getContext('2d');
                this.data = {}
            }

            clearCanvas() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawRectangle(x, y, width, height, color) {
                this.context.fillStyle = color;
                this.context.fillRect(x, y, width, height);
            }

            drawCircle(x, y, radius, color) {
                this.context.fillStyle = color;
                this.context.beginPath();
                this.context.arc(x, y, radius, 0, 2 * Math.PI);
                this.context.fill();
            }

            drawText(text, x, y, font, color) {
                this.context.fillStyle = color;
                this.context.font = font;
                this.context.fillText(text, x, y);
            }

            createCartesianGraph(xAxisLabel, yAxisLabel, xMin, xMax, yMin, yMax) {
                const ctx = this.context;
                const canvasWidth = this.canvas.width;
                const canvasHeight = this.canvas.height;
                const xAxisSpacing = 5; // Spaziatura per le ascisse
                const yAxisSpacing = 5; // Spaziatura per le ordinate

                // Disegna assi
                ctx.beginPath();
                ctx.moveTo(0, canvasHeight / 2);
                ctx.lineTo(canvasWidth, canvasHeight / 2);
                ctx.moveTo(canvasWidth / 2, 0);
                ctx.lineTo(canvasWidth / 2, canvasHeight);
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Etichette sugli assi
                ctx.font = '12px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(xAxisLabel, canvasWidth - 10, canvasHeight / 2 - 10);
                ctx.fillText(yAxisLabel, canvasWidth / 2 + 10, 10);

                // Calcola scaling
                const xScale = canvasWidth / (xMax - xMin);
                const yScale = canvasHeight / (yMax - yMin);

                // Disegna numeri sulle ascisse
                for (let x = xMin; x <= xMax; x++) {
                    const xCoord = x * xScale + canvasWidth / 2;
                    ctx.beginPath();
                    ctx.moveTo(xCoord, canvasHeight / 2 - xAxisSpacing / 2);
                    ctx.lineTo(xCoord, canvasHeight / 2 + xAxisSpacing / 2);
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillText(x.toString(), xCoord, canvasHeight / 2 + xAxisSpacing);
                }

                // Disegna numeri sulle ordinate
                for (let y = yMin; y <= yMax; y++) {
                    const yCoord = canvasHeight / 2 - y * yScale;
                    ctx.beginPath();
                    ctx.moveTo(canvasWidth / 2 - yAxisSpacing / 2, yCoord);
                    ctx.lineTo(canvasWidth / 2 + yAxisSpacing / 2, yCoord);
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillText(y.toString(), canvasWidth / 2 - yAxisSpacing, yCoord);
                }

                return { xScale, yScale, xMin, yMin };
            }

            simulateSecurityTrajectories() {
            
            this.clearCanvas()
            var N = parseInt(document.getElementById("numSystems").value);
            var M = parseInt(document.getElementById("numAttacks").value);
            var p = parseFloat(document.getElementById("attackProbability").value);
            var startPoint = parseInt(document.getElementById("startPoint").value);

            this.createCartesianGraph('X', 'Y', startPoint, M, -M, M);

            const successfulAttacks = new Array(M).fill(0); // Array per tenere traccia delle penetrazioni riuscite

            for (let systemIndex = 0; systemIndex < N; systemIndex++) {
                
                this.data[systemIndex] = [];//dizionario di liste

                const xScale = this.canvas.width / (M - startPoint);
                const yScale = this.canvas.height / (2 * (M-startPoint));

                let xCoord = (startPoint) * xScale + this.canvas.width / 2;
                let yCoord = this.canvas.height / 2;

                this.context.beginPath();
                this.context.strokeStyle = colors[systemIndex % colors.length];
                this.context.lineWidth = 2;
                this.context.moveTo(xCoord, yCoord);

                for (let attackIndex = startPoint; attackIndex < M; attackIndex++) {

                    xCoord += xScale; // Sposta lungo l'asse X
                    // Simula il punteggio di sicurezza basato sulla probabilità di penetrazione
                    const score = Math.random() <= p ? -1 : 1;
                    yCoord -= score * yScale; // Sottrai il punteggio invece di aggiungerlo

                    if (score === 1) {
                        // Incrementa il conteggio delle penetrazioni riuscite
                        this.data[systemIndex][attackIndex] = 1;
                    }else{
                        this.data[systemIndex][attackIndex] = 0;
                    }

                    // Disegna un segmento di linea per questo punteggio
                    this.context.lineTo(xCoord, yCoord);
                }

                this.context.stroke();
            }
        }

            updateCanvasSize() {
                console.log("resize")
                
                this.canvas.width = parseFloat(getComputedStyle(this.canvas).width);
                this.canvas.height = parseFloat(getComputedStyle(this.canvas).height);
                //this.restoreMainCanvasContext()
            }

            drawCumulativeGraph() {
                console.log(this.data)
                var N = parseInt(document.getElementById("numSystems").value);    
                var M = parseInt(document.getElementById("numAttacks").value);
                var startPoint = parseInt(document.getElementById("startPoint").value);
                this.clearCanvas();
                this.createCartesianGraph('Attacchi', 'Sicurezza', startPoint, M, -M, M);

                // Itera sui sistemi
                for (let systemIndex = 0; systemIndex < N; systemIndex++) {
                    const xScale = this.canvas.width / (M - startPoint);
                    const yScale = this.canvas.height / (2 * (M - startPoint));
                    let xCoord = (startPoint) * xScale + this.canvas.width / 2;
                    let yCoord = this.canvas.height / 2;

                    this.context.beginPath();
                    this.context.strokeStyle = colors[systemIndex % colors.length];
                    this.context.lineWidth = 2;
                    this.context.moveTo(xCoord, yCoord);

                    console.log(this.data)

                    // Itera sugli attacchi
                    for (let attackIndex = startPoint; attackIndex < M; attackIndex++) {
                        // Ottieni il valore del sistema specifico e disegnalo
                        let value = this.data[systemIndex][attackIndex];
                        console.log(value)
                        xCoord += xScale;
                        yCoord -= value * yScale;

                        // Disegna un segmento di linea per questo punteggio
                        this.context.lineTo(xCoord, yCoord);
                    }
                    this.context.stroke();
                }
            }



            

        }

        class ResizableRectangle {
            constructor(rectangle, canvas, utilities) {
                this.rectangle = rectangle;
                this.canvas = canvas;
                this.canvasUtilities = utilities;
                this.canvasUtilities.clearCanvas();
                this.canvasUtilities.createCartesianGraph('X', 'Y', -10, 10, -20, 20);
                this.attachListeners();
            }

            attachListeners() {
                this.rectangle.addEventListener('mousedown', (e) => {
                    this.startResize(e);
                });

                window.addEventListener('mousemove', (e) => {
                    this.resize(e);
                });

                window.addEventListener('mouseup', () => {
                    this.stopResize();
                });
            }

            startResize(e) {
                this.resizing = true;
                this.initialX = e.clientX;
                this.initialY = e.clientY;
            }

            resize(e) {
                if (!this.resizing) return;
                const deltaX = e.clientX - this.initialX;
                const deltaY = e.clientY - this.initialY;

                const newWidth = this.rectangle.offsetWidth + deltaX;
                const newHeight = this.rectangle.offsetHeight + deltaY;

                this.rectangle.style.width = `${newWidth}px`;
                this.rectangle.style.height = `${newHeight}px`;

                // Resize the canvas to match the new rectangle size
                this.canvas.width = newWidth;
                this.canvas.height = newHeight;

                this.initialX = e.clientX;
                this.initialY = e.clientY;

                this.canvasUtilities.updateCanvasSize();
            }

            stopResize() {
                this.resizing = false;
                this.canvasUtilities.simulateSecurityTrajectories(); // Correzione qui
            }
        }

        const canvasUtilities = new My2dUtilities('securityChart');
        const resizableRectangle = new ResizableRectangle(
            document.getElementById('resizableRect'),
            document.getElementById('securityChart'),
            canvasUtilities
        );

        canvasUtilities.createCartesianGraph()
        canvasUtilities.simulateSecurityTrajectories()


        const canvasUtilitiesCumulative = new My2dUtilities('cumulativeChart');
        const resizableRectangleCumulative = new ResizableRectangle(
            document.getElementById('cumulativeGraph'),
            document.getElementById('cumulativeChart'),
            canvasUtilitiesCumulative
        );

        canvasUtilitiesCumulative.drawCumulativeGraph()
        /*
        const canvasUtilitiesRelative = new My2dUtilities('relativeChart');
        const resizableRectangleRelative = new ResizableRectangle(
            document.getElementById('relativeGraph'),
            document.getElementById('relativeChart'),
            canvasUtilitiesRelative
        );

        const canvasUtilitiesNormalized = new My2dUtilities('normalizedChart');
        const resizableRectangleNormalized = new ResizableRectangle(
            document.getElementById('normalizedGraph'),
            document.getElementById('normalizedChart'),
            canvasUtilitiesNormalized
        );
        */

        document.addEventListener('DOMContentLoaded', function () {
            var simulazioneButton = document.getElementById('simulazione');
            simulazioneButton.addEventListener('click', function () {
                canvasUtilities.simulateSecurityTrajectories();
            });
        });
      

    </script>
</body>
</html>
